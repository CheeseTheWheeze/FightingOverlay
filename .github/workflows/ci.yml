name: CI

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: "Guardrail: ensure workflow has no truncated paths"
        shell: pwsh
        run: |
          $matches = Get-ChildItem .github/workflows -Filter *.yml | Select-String -Pattern '\.\.\.'
          if ($matches) { throw "Workflow contains literal three-dot tokens. Fix the file and retry." }
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements/ci.txt
      - name: Build bootstrapper
        run: |
          pyinstaller --onefile --name FightingOverlayBootstrap bootstrap/main.py
      - name: Build Control Center
        run: |
          pyinstaller --onedir --name ControlCenter --collect-all cv2 apps/control_center/main.py
      - name: Inventory Control Center build outputs
        shell: pwsh
        run: |
          Write-Host "dist/ listing (first 200 entries):"
          Get-ChildItem dist -Recurse -Force |
            Select-Object -First 200 FullName, Length |
            ForEach-Object { Write-Host "$($_.FullName) $($_.Length)" }

          $controlCenterExe = Get-ChildItem dist -Recurse -Filter ControlCenter.exe | Select-Object -First 1
          if (-not $controlCenterExe) {
            Write-Host "ControlCenter.exe not found in dist output. Full dist listing:"
            Get-ChildItem dist -Recurse -Force | Select-Object FullName, Length | Out-String | Write-Host
            throw 'Unable to locate ControlCenter.exe in dist output'
          }

          "CONTROL_CENTER_EXE=$($controlCenterExe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Discovered ControlCenter.exe at $($controlCenterExe.FullName)"
      - name: Prepare release assets
        run: |
          pwsh -Command @'
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          $bootstrapExe = @(
            'dist/FightingOverlayBootstrap.exe',
            'dist/FightingOverlayBootstrap/FightingOverlayBootstrap.exe'
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $bootstrapExe) { throw 'Unable to locate FightingOverlayBootstrap.exe in dist output' }

          if (-not $env:CONTROL_CENTER_EXE) { throw 'CONTROL_CENTER_EXE is not set' }
          if (-not (Test-Path $env:CONTROL_CENTER_EXE)) { throw "CONTROL_CENTER_EXE does not exist: $env:CONTROL_CENTER_EXE" }
          $controlCenterExe = Get-Item $env:CONTROL_CENTER_EXE
          $controlCenterDir = $controlCenterExe.Directory.FullName

          "BOOTSTRAP_EXE=$bootstrapExe" | Out-File -FilePath $env:GITHUB_ENV -Append

          New-Item -ItemType Directory -Force release_upload | Out-Null
          Copy-Item $bootstrapExe release_upload/FightingOverlayBootstrap.exe -Force

          $stageDir = Join-Path $PWD 'release_stage'
          if (Test-Path $stageDir) { Remove-Item -Recurse -Force $stageDir }
          New-Item -ItemType Directory -Force $stageDir | Out-Null
          if ($controlCenterExe.Directory.Name -eq 'ControlCenter') {
            Copy-Item -Path (Join-Path $controlCenterDir '*') -Destination $stageDir -Recurse -Force
          } else {
            Copy-Item -Path $controlCenterExe.FullName -Destination (Join-Path $stageDir 'ControlCenter.exe') -Force
            Get-ChildItem -Path $controlCenterDir -File |
              Where-Object { $_.Name -ne $controlCenterExe.Name -and $_.Name -ne 'FightingOverlayBootstrap.exe' } |
              ForEach-Object {
                Copy-Item -Path $_.FullName -Destination (Join-Path $stageDir $_.Name) -Force
              }
          }
          if (-not (Test-Path (Join-Path $stageDir 'ControlCenter.exe'))) {
            Write-Host "ControlCenter.exe not staged."
            Write-Host "ControlCenter.exe source: $($controlCenterExe.FullName)"
            Write-Host "ControlCenter directory: $controlCenterDir"
            Write-Host "release_stage contents (first 200 entries):"
            Get-ChildItem -Path $stageDir -Recurse -Force |
              Select-Object -First 200 FullName |
              ForEach-Object { Write-Host $_.FullName }
            throw 'ControlCenter.exe was not staged at release_stage/ControlCenter.exe'
          }
          "CONTROL_CENTER_STAGE_EXE=$(Join-Path $stageDir 'ControlCenter.exe')" | Out-File -FilePath $env:GITHUB_ENV -Append
          Get-ChildItem -Path $stageDir -Recurse -Filter '*.zip' |
            Where-Object { $_.Name -ne 'base_library.zip' } |
            Remove-Item -Force

          Compress-Archive -Path (Join-Path $stageDir '*') -DestinationPath release_upload/FightingOverlay-Full-Windows.zip -Force
          '@
      - name: "Guardrail: verify Full-Windows.zip"
        shell: pwsh
        run: |
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          $zipPath = "release_upload/FightingOverlay-Full-Windows.zip"
          if (-not (Test-Path $zipPath)) { throw "Missing zip: $zipPath" }
          $zipInfo = Get-Item $zipPath
          $zip = [System.IO.Compression.ZipFile]::OpenRead($zipPath)
          try {
            $entryNames = $zip.Entries | ForEach-Object { $_.FullName }
            $normalizedEntries = $entryNames | ForEach-Object { $_ -replace '\\','/' }
            $zipEntries = $normalizedEntries | Where-Object { $_ -match '\.zip$' }
            $unexpected = $zipEntries | Where-Object { $_ -notmatch 'base_library\.zip$' }
            $exeEntries = $normalizedEntries | Where-Object {
              $lower = $_.ToLower()
              $lower -eq 'controlcenter.exe' -or
              $lower -eq './controlcenter.exe' -or
              $lower.EndsWith('/controlcenter.exe')
            }
            if (-not $exeEntries -or $unexpected) {
              Write-Host "Zip path: $zipPath"
              Write-Host "Zip size: $($zipInfo.Length) bytes"
              $topLevel = $entryNames |
                ForEach-Object { ($_ -split '[\\/]', 2)[0] } |
                Where-Object { $_ -ne '' } |
                Sort-Object -Unique
              Write-Host "Top-level entries:"
              $topLevel | ForEach-Object { Write-Host $_ }
              Write-Host "First 200 entries:"
              $entryNames | Select-Object -First 200 | ForEach-Object { Write-Host $_ }
              if ($unexpected) {
                throw ("Unexpected nested zip entries: " + ($unexpected -join ", "))
              }
              throw "ControlCenter.exe not found in release zip."
            }
          } finally {
            $zip.Dispose()
          }
      - name: Run Control Center test mode
        shell: pwsh
        run: |
          if (-not $env:CONTROL_CENTER_STAGE_EXE) { throw "CONTROL_CENTER_STAGE_EXE is not set" }
          if (-not (Test-Path $env:CONTROL_CENTER_STAGE_EXE)) { throw "CONTROL_CENTER_STAGE_EXE does not exist: $env:CONTROL_CENTER_STAGE_EXE" }
          & $env:CONTROL_CENTER_STAGE_EXE --test-mode
      
      - name: Run Control Center UI smoke test (python)
        run: |
          python -m apps.control_center.main --ui-smoke-test
      - name: Run schema validation tests
        run: |
          python -m unittest discover -s tests
      - name: Run Bootstrap self-test
        run: |
          dist/FightingOverlayBootstrap.exe --self-test
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fightingoverlay-builds
          path: |
            release_upload/FightingOverlayBootstrap.exe
            release_upload/FightingOverlay-Full-Windows.zip

  release:
    needs: build-windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: fightingoverlay-builds
          path: release_assets
      - name: Prepare release upload folder
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force release_upload | Out-Null
          Copy-Item "release_assets/FightingOverlayBootstrap.exe" "release_upload/FightingOverlayBootstrap.exe" -Force
          Copy-Item "release_assets/FightingOverlay-Full-Windows.zip" "release_upload/FightingOverlay-Full-Windows.zip" -Force
      - name: Verify release upload assets
        shell: pwsh
        run: |
          Get-ChildItem -Path release_upload | Format-List -Property FullName,Length
          if (-not (Test-Path -Path "release_upload/FightingOverlayBootstrap.exe")) { throw "Missing FightingOverlayBootstrap.exe in release_upload" }
          if (-not (Test-Path -Path "release_upload/FightingOverlay-Full-Windows.zip")) { throw "Missing FightingOverlay-Full-Windows.zip in release_upload" }
      - name: Create archive tag
        shell: pwsh
        run: |
          $ts = Get-Date -Format "yyyyMMdd-HHmm"
          $sha = "${{ github.sha }}".Substring(0,7)
          $tag = "build-$ts-$sha"
          "ARCHIVE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append

          $payload = @{
            ref = "refs/tags/$tag"
            sha = "${{ github.sha }}"
          } | ConvertTo-Json

          $headers = @{
            Authorization = "Bearer $env:GITHUB_TOKEN"
            Accept = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
          }

          $uri = "https://api.github.com/repos/${{ github.repository }}/git/refs"
          Invoke-RestMethod -Method Post -Uri $uri -Headers $headers -Body $payload | Out-Null
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create archive release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.ARCHIVE_TAG }}
          name: Archived build ${{ env.ARCHIVE_TAG }}
          prerelease: false
          draft: false
          files: |
            release_upload/FightingOverlayBootstrap.exe
            release_upload/FightingOverlay-Full-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Remove existing latest release tag
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $headers = @{
            Authorization = "Bearer $env:GITHUB_TOKEN"
            Accept = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
          }
          $repo = "${{ github.repository }}"
          try {
            $release = Invoke-RestMethod -Method Get -Uri "https://api.github.com/repos/$repo/releases/tags/latest" -Headers $headers
          } catch {
            $release = $null
          }
          if ($release -and $release.id) {
            Invoke-RestMethod -Method Delete -Uri "https://api.github.com/repos/$repo/releases/$($release.id)" -Headers $headers
          }
          try {
            Invoke-RestMethod -Method Delete -Uri "https://api.github.com/repos/$repo/git/refs/tags/latest" -Headers $headers
          } catch {
          }
      - name: Create latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Windows Build
          prerelease: false
          draft: false
          make_latest: true
          files: |
            release_upload/FightingOverlayBootstrap.exe
            release_upload/FightingOverlay-Full-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
