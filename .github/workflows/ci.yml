name: CI

on:
  push:
    branches: ["**"]
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller
      - name: Build bootstrapper
        run: |
          pyinstaller --onefile --name FightingOverlayBootstrap bootstrap/main.py
      - name: Build Control Center
        run: |
          pyinstaller --onedir --name ControlCenter apps/control_center/main.py
      - name: Package Full Zip
        run: |
          powershell -Command "Compress-Archive -Path dist/ControlCenter/* -DestinationPath dist/ControlCenter.zip"
      - name: Prepare release assets
        run: |
          powershell -Command "New-Item -ItemType Directory -Force dist | Out-Null"
          powershell -Command "Copy-Item dist/FightingOverlayBootstrap.exe dist/FightingOverlayBootstrap.exe -Force"
          powershell -Command "Move-Item dist/ControlCenter.zip dist/FightingOverlay-Full-Windows.zip -Force"
      - name: Run Control Center test mode
        run: |
          dist/ControlCenter/ControlCenter.exe --test-mode
        continue-on-error: true
      - name: Run Bootstrap self-test
        run: |
          dist/FightingOverlayBootstrap.exe --self-test
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fightingoverlay-builds
          path: |
            dist/FightingOverlayBootstrap.exe
            dist/FightingOverlay-Full-Windows.zip

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build-windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: fightingoverlay-builds
          path: release_assets
      - name: Prepare release upload folder
        run: |
          powershell -Command "New-Item -ItemType Directory -Force release_upload | Out-Null"
          powershell -Command "Copy-Item release_assets/dist/FightingOverlayBootstrap.exe release_upload/FightingOverlayBootstrap.exe -Force"
          powershell -Command "Copy-Item release_assets/dist/FightingOverlay-Full-Windows.zip release_upload/FightingOverlay-Full-Windows.zip -Force"
      - name: Verify release upload assets
        run: |
          powershell -Command "Get-ChildItem -Path release_upload | Format-List -Property FullName,Length"
          powershell -Command "if (-not (Test-Path -Path release_upload/FightingOverlayBootstrap.exe)) { throw 'Missing FightingOverlayBootstrap.exe in release_upload' }"
          powershell -Command "if (-not (Test-Path -Path release_upload/FightingOverlay-Full-Windows.zip)) { throw 'Missing FightingOverlay-Full-Windows.zip in release_upload' }"
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release_upload/FightingOverlayBootstrap.exe
            release_upload/FightingOverlay-Full-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
